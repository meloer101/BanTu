# Socially 上线部署清单

从工程师与产品视角，部署到公网前需要补齐和检查的项。

---

## 一、必须项（不做会直接导致线上不可用或违规）

### 1. 环境变量与密钥

- [ ] **生产环境配置所有变量**（参考 `.env.example`）  
  - `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` / `CLERK_SECRET_KEY`：使用 **Clerk 生产环境** 的 key（不要用 `pk_test_` / `sk_test_`）。  
  - `DATABASE_URL`：生产用 PostgreSQL（你已在用 Neon，可继续用同一服务或新建生产库）。  
  - `UPLOADTHING_TOKEN`：在 [UploadThing Dashboard](https://uploadthing.com) 创建应用并填写，否则发帖上传图片会失败。

- [ ] **不要把 `.env` 提交到 Git**（已通过 `.gitignore` 忽略）。在 Vercel/其他平台的项目设置里填环境变量。

### 2. Clerk 生产配置

- [ ] 在 [Clerk Dashboard](https://dashboard.clerk.com) 切换到 **Production** 实例，创建并启用生产应用。  
- [ ] 在 **Configure → Paths / URLs** 中设置：  
  - **Sign-in / Sign-up 成功后的跳转 URL**（如 `https://你的域名.com`）。  
  - **Allowed redirect URLs** 中加入你的生产域名（如 `https://你的域名.com/**`）。  
- [ ] 若用自定义域名，在 **Domains** 里添加并按提示完成校验。

不配置会导致：登录后跳转错误、Session 异常或无法登录。

### 3. 代码与运行环境

- [x] **已修复**：`/tasks` 页面原先写死 `http://localhost:3000`，在线上会请求失败；已改为使用 `VERCEL_URL` 或 `NEXT_PUBLIC_APP_URL`。  
- [ ] **数据库迁移**：首次部署前在本地或 CI 执行一次 `npx prisma migrate deploy`（或 `prisma db push` 仅做原型时用），确保生产库表结构一致。

### 4. 默认头像与图标（体验必需）

- [ ] **默认头像**：多处使用 `/avatar.png`，需在 `public/` 下放一张 `avatar.png`，否则未设置头像的用户会 404。  
- [ ] **站点图标**：在 `src/app/` 下放 `icon.png`（或 `favicon.ico`），否则浏览器标签为空白，分享链接也不好看。  
  - 例如：添加 `src/app/icon.png`（建议 32×32 或 48×48），Next.js 会自动作为 favicon。

---

## 二、强烈建议（合规与长期运维）

### 5. 法律与合规（产品经理视角）

- [ ] **隐私政策（Privacy Policy）**  
  收集了邮箱、用户名、头像、发帖与关注关系等，属于个人数据。上线前应提供隐私政策页面（说明收集什么、用于何处、保留多久、用户权利），并可在注册/设置中放链接。很多地区（如欧盟 GDPR、加州 CCPA）或应用商店对此有要求。

- [ ] **服务条款（Terms of Service）**  
  说明使用规则、禁止行为、责任限制等，有利于纠纷时站得住脚。

- [ ] **页脚或设置页**  
  在全局 Footer 或「关于/设置」里放「隐私政策」「服务条款」链接（可先链到静态页面或 Notion/Google Doc）。

### 6. 错误与加载体验（工程师视角）

- [ ] **根级错误边界**：在 `src/app/error.tsx` 中实现一个 fallback UI（如「出错了，请刷新或联系支持」），避免白屏。  
- [ ] **关键路由 loading**：在 `src/app/loading.tsx` 或重要子路由（如 `notifications/loading.tsx`）加骨架屏或 Spinner，减少「卡住」的感觉。

### 7. 安全与稳定性

- [ ] **Next.js 安全头（可选但推荐）**  
  在 `next.config.mjs` 中增加 `headers`：  
  - `X-Frame-Options: DENY`  
  - `X-Content-Type-Options: nosniff`  
  - `Referrer-Policy: strict-origin-when-cross-origin`  
  可降低点击劫持、MIME 嗅探等问题。

- [ ] **上传与接口防滥用（可选）**  
  UploadThing 和 Clerk 自带一定限制；若担心恶意注册或刷接口，可后续加：  
  - Clerk 的 rate limit / 人机验证；  
  - 或对 `/api/*` 做简单限流（如 Vercel 的 Edge 或 Upstash Ratelimit）。

---

## 三、可选增强（上线后可逐步做）

| 项 | 说明 |
|----|------|
| **图片优化** | 帖子/头像目前用 `<img>`，可逐步改为 `next/image`，减少体积、统一尺寸、配合 CDN。 |
| **错误监控** | 接入 Sentry（或类似）捕获未处理异常与 500，便于排查线上问题。 |
| **健康检查** | 增加 `/api/health`（如查 DB 连通性），供平台或监控做存活探测。 |
| **SEO / 爬虫** | 需要被收录时，可加 `src/app/robots.txt`、`sitemap.ts`。 |
| **移动端 Profile 链接** | `MobileNavbar` 里 Profile 当前指向 `/profile`，与动态路由 `/profile/[username]` 不一致，可改为当前用户 username 的 profile 链接。 |

---

## 四、部署平台简要（Vercel 为例）

1. 仓库连接 Vercel，框架选 Next.js，根目录正确。  
2. **Environment Variables** 中填入上述所有生产环境变量（含 Clerk 生产 key、生产 `DATABASE_URL`、`UPLOADTHING_TOKEN`）。  
3. 若自托管或非 Vercel，设置 `NEXT_PUBLIC_APP_URL` 为最终访问的根 URL。  
4. 部署前在本地执行 `npm run build` 确认无报错；部署后执行一次 `npx prisma migrate deploy`（或在你提供的「部署后脚本」里执行）。  
5. 在 Clerk 的 Allowed redirect URLs 中加入 Vercel 分配的生产域名（如 `https://xxx.vercel.app/**`）。

---

## 五、上线前自检列表（复制用）

```
[ ] 生产 Clerk key + 生产域名/redirect 已在 Clerk 配置
[ ] DATABASE_URL 指向生产库，并已执行迁移
[ ] UPLOADTHING_TOKEN 已配置
[ ] public/avatar.png 存在
[ ] src/app/icon.png（或 favicon.ico）存在
[ ] 隐私政策/服务条款至少有一处入口（可先链外链）
[ ] src/app/error.tsx 已加（推荐）
[ ] npm run build 通过
```

完成以上「必须项」和「强烈建议」后，即可安全部署到公网；其余项可按迭代逐步补上。

---

## 六、常见线上问题

| 现象 | 可能原因 | 处理 |
|------|----------|------|
| Runtime Logs 报 `500`、`Failed to fetch posts` | Vercel 未配置或配错 **DATABASE_URL**，Prisma 连不上数据库 | 在 Vercel → Project → Settings → Environment Variables 中为 **Production** 添加正确的 `DATABASE_URL`（Neon 生产库连接串），保存后重新部署。 |
| 首页显示「出错了」、右侧错误卡片 | 同上，首页拉帖失败触发错误边界 | 同上；若已配置仍报错，检查 Neon 控制台该库是否可外网访问、连接串是否含 `?sslmode=require`。 |
| 点击 Login / Sign In / Sign Up 无反应，hover 无链接 | 1）页面 500 导致前端异常；2）Vercel 未配置 **NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY** / **CLERK_SECRET_KEY**，Clerk 无法初始化 | 先按上表修好 500 与 DATABASE_URL；再在 Vercel 环境变量中补全 Clerk 两个 key（Production）。Login/Sign In 是弹窗按钮不是链接，无 href 属正常。 |
| 登录后跳转错误或白屏 | Clerk 的 **Allowed redirect URLs** 未包含当前站点 | 在 Clerk Dashboard → Configure → Paths / URLs（或 Account Portal 相关设置）中，将 `https://ban-tu.vercel.app`、`https://你的自定义域名` 等加入 Allowed redirect URLs。 |
