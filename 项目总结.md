# Next.js 社交应用项目总结

## 一、项目概览

- **项目名称**：Socially
- **定位**：基于 Next.js 全栈教程构建的现代社交应用（类 Twitter/X 的简化版）
- **技术栈**：Next.js 14 App Router、PostgreSQL、Prisma、Clerk、TypeScript、Tailwind CSS、Shadcn UI、UploadThing
- **包管理**：npm，`package.json` 中项目名为 `socially`，版本 `0.1.0`

---

## 二、技术架构

### 2.1 核心技术

| 类别 | 技术 | 说明 |
|------|------|------|
| 框架 | Next.js 14.2.15 | App Router、RSC、Route Handlers、Server Actions |
| 语言 | TypeScript 5 | 严格模式，路径别名 `@/*` → `./src/*` |
| 数据库 | PostgreSQL | 通过 Prisma ORM 访问 |
| ORM | Prisma 6.1.0 | schema 在 `prisma/schema.prisma`，单例在 `src/lib/prisma.ts` |
| 认证 | Clerk (@clerk/nextjs 6.9.6) | 登录/注册、用户同步、中间件保护 |
| 文件上传 | UploadThing 7.x | 帖子图片，Route Handler + React 组件 |
| 样式 | Tailwind CSS 3.4 + tailwindcss-animate | 主题变量在 `globals.css`，支持明暗主题 |
| UI 组件库 | Shadcn (new-york 风格) | Radix UI + CVA + clsx + tailwind-merge，`components.json` 配置 |
| 图标 | Lucide React | 全局使用 |
| 字体 | 本地 Geist | GeistVF.woff / GeistMonoVF，CSS 变量 `--font-geist-sans`、`--font-geist-mono` |
| 提示 | react-hot-toast | 成功/失败反馈 |
| 主题切换 | next-themes | 跟随系统、明/暗切换，禁用切换时的过渡 |

### 2.2 项目结构（src）

```
src/
├── app/                    # App Router
│   ├── layout.tsx          # 根布局：ClerkProvider、ThemeProvider、Navbar、Sidebar、Toaster
│   ├── page.tsx            # 首页：发帖区 + 帖子流 + WhoToFollow
│   ├── globals.css         # 全局样式、Tailwind、CSS 变量（明/暗）
│   ├── api/
│   │   ├── uploadthing/    # UploadThing 的 route + core 配置
│   │   └── tasks/          # 示例 API：内存版 CRUD（GET/POST/DELETE）
│   ├── profile/[username]/ # 动态用户主页
│   │   ├── page.tsx        # 服务端：拉取用户、帖子、喜欢、关注状态
│   │   ├── ProfilePageClient.tsx  # 客户端：展示与编辑资料、关注、帖子/喜欢 Tab
│   │   └── not-found.tsx   # 用户不存在时 404
│   ├── notifications/      # 通知列表页（客户端拉取 + 已读）
│   └── tasks/              # 示例页：请求 /api/tasks 并展示（仅占位）
├── actions/                # Server Actions（"use server"）
│   ├── post.action.ts      # 帖子：创建、列表、点赞、评论、删除
│   ├── user.action.ts      # 用户：同步 Clerk→DB、getDbUserId、随机用户、关注
│   ├── profile.action.ts   # 资料：按 username 查、用户帖子、喜欢帖子、更新资料、是否关注
│   └── notification.action.ts  # 通知：列表、标记已读
├── components/
│   ├── ui/                 # Shadcn 基础组件（button、card、dialog、avatar 等）
│   ├── Navbar.tsx          # 顶部导航（含 syncUser）
│   ├── DesktopNavbar.tsx   # 桌面端：Home、Notifications、Profile、UserButton、ModeToggle
│   ├── MobileNavbar.tsx    # 移动端：Sheet 菜单、主题、登出
│   ├── Sidebar.tsx         # 侧栏：当前用户卡片或未登录欢迎
│   ├── CreatePost.tsx      # 发帖（文字 + 图片 UploadThing）
│   ├── PostCard.tsx        # 单条帖子：点赞（乐观更新）、评论、删除
│   ├── WhoToFollow.tsx     # 推荐关注（随机 3 人，排除已关注）
│   ├── FollowButton.tsx    # 关注按钮
│   ├── ImageUpload.tsx     # 图片上传（UploadDropzone）
│   ├── DeleteAlertDialog.tsx # 删除确认弹窗
│   ├── ThemeProvider.tsx   # next-themes 包装
│   ├── ModeToggle.tsx      # 明/暗切换
│   └── NotificationSkeleton.tsx # 通知页骨架屏
├── lib/
│   ├── prisma.ts           # Prisma 单例（开发环境 globalThis 复用）
│   ├── utils.ts            # cn() 工具（clsx + tailwind-merge）
│   └── uploadthing.ts      # UploadButton/UploadDropzone 封装
└── middleware.ts           # Clerk 中间件（排除静态资源与 _next）
```

---

## 三、数据模型（Prisma）

### 3.1 实体与关系

- **User**  
  - 字段：id(cuid)、email、username、clerkId（唯一）、name、bio、image、location、website、createdAt、updatedAt  
  - 关系：帖子、评论、点赞、关注/被关注（Follows）、通知（接收/创建）

- **Post**  
  - 字段：id、authorId、content、image、createdAt、updatedAt  
  - 关系：作者 User、Comment[]、Like[]、Notification[]  
  - 删除：`onDelete: Cascade`（作者删除则帖子删除）

- **Comment**  
  - 字段：id、content、authorId、postId、createdAt  
  - 复合索引：`@@index([authorId, postId])`  
  - 级联：作者/帖子删除则评论删除

- **Like**  
  - 字段：id、postId、userId、createdAt  
  - 唯一约束：`@@unique([userId, postId])`，防止重复点赞  
  - 索引：`@@index([userId, postId])`

- **Follows**  
  - 字段：followerId、followingId、createdAt  
  - 复合主键：`@@id([followerId, followingId])`  
  - 索引：`@@index([followerId, followingId])`  
  - 级联：用户删除时关注关系删除

- **Notification**  
  - 字段：id、userId、creatorId、type(enum)、read、postId、commentId、createdAt  
  - 枚举：`NotificationType = LIKE | COMMENT | FOLLOW`  
  - 索引：`@@index([userId, createdAt])`  
  - 关系：接收用户、触发用户、可选 Post、可选 Comment

### 3.2 设计要点

- 用户与 Clerk 通过 `clerkId` 唯一同步；业务侧统一用 DB 的 `User.id`。
- 点赞、关注、通知在业务逻辑中与事务配合（如点赞/关注时写通知）。
- 帖子、评论、点赞、关注均使用级联删除，保证数据一致性。

---

## 四、功能模块详解

### 4.1 认证与用户同步

- **Clerk**：登录/注册、Session、`currentUser`/`auth()`、`UserButton`、`SignInButton`/`SignUpButton`。
- **中间件**：`src/middleware.ts` 使用 `clerkMiddleware()`，对非静态、非 `_next` 的请求进行认证处理。
- **同步**：在 `Navbar` 服务端组件中，若 `currentUser` 存在则调用 `syncUser()`，将 Clerk 用户写入或匹配到 Prisma `User`（clerkId、name、username、email、image），保证后续 Server Actions 都能用 `getDbUserId()` 拿到 DB 用户 id。

### 4.2 帖子（Post）

- **创建**：`CreatePost` 组件（文字 + 可选图片），调用 `createPost(content, image)` Server Action；图片经 UploadThing `postImage` 上传后传入 URL；成功后 `revalidatePath("/")`。
- **列表**：首页服务端调用 `getPosts()`，按时间倒序，包含 author、comments（含评论作者）、likes、`_count.likes/comments`。
- **点赞**：`PostCard` 内 `toggleLike(postId)`，乐观更新点赞数与红心状态；若点赞他人帖子则创建 LIKE 通知。
- **评论**：`PostCard` 内展开评论区，调用 `createComment(postId, content)`，对他人帖子会创建 COMMENT 通知；评论与通知在同一事务中完成。
- **删除**：仅作者可见删除按钮，`DeleteAlertDialog` 确认后调用 `deletePost(postId)`，校验 authorId 后删除并 revalidate。

### 4.3 用户与资料

- **资料页**：`/profile/[username]`，服务端根据 `username` 取用户信息、帖子、喜欢的帖子、当前用户是否关注，交给 `ProfilePageClient`。
- **动态元数据**：`generateMetadata` 使用 `getProfileByUsername` 生成 title/description。
- **编辑资料**：本人可见「Edit Profile」，弹窗表单（name、bio、location、website）提交 `updateProfile(formData)`，成功后 revalidate `/profile`。
- **关注/取关**：`toggleFollow(targetUserId)`，关注时同时创建 FOLLOW 通知；`FollowButton`、资料页关注按钮均使用该 Action。
- **Who to follow**：`getRandomUsers()` 排除当前用户和已关注用户，取 3 条，用于首页侧栏推荐。

### 4.4 通知

- **类型**：LIKE（点赞帖子）、COMMENT（评论帖子）、FOLLOW（被关注）。
- **列表**：`/notifications` 页面客户端挂载后调用 `getNotifications()`，展示创建者、类型、关联帖子/评论、时间；进入页面后对未读 id 调用 `markNotificationsAsRead(notificationIds)`。
- **加载态**：`NotificationsSkeleton` 骨架屏。

### 4.5 文件上传

- **UploadThing**：  
  - `app/api/uploadthing/core.ts` 定义 `postImage`：类型 image，单文件最大 4MB，middleware 中校验 Clerk `userId`。  
  - `app/api/uploadthing/route.ts` 使用 `createRouteHandler` 暴露 GET/POST。  
- **前端**：`ImageUpload` 使用 `UploadDropzone`，上传完成后将返回的 URL 通过 `onChange` 传给 `CreatePost`，用于 `createPost(..., imageUrl)`。

### 4.6 示例 API 与页面

- **`/api/tasks`**：内存数组实现 GET（列表）、POST（创建）、DELETE（按 id 删除），用于演示 Route Handler。
- **`/tasks`**：服务端 fetch `http://localhost:3000/api/tasks`（cache: no-store），控制台打印并占位渲染「TasksPage」，未做完整 UI。

---

## 五、前端与 UX

### 5.1 布局与导航

- **根布局**：顶部 `Navbar`、主内容区 `max-w-7xl` 居中、左侧 3 列 Sidebar（lg 以上）、右侧 9 列主内容；底部 Toaster。
- **导航**：桌面端 Home、Notifications、Profile、主题切换、Clerk UserButton；移动端 Sheet 菜单，含主题、登出。
- **侧栏**：已登录显示当前用户头像、姓名、username、bio、关注/被关注数、location、website；未登录显示欢迎与登录/注册入口。

### 5.2 主题与样式

- **明/暗**：`globals.css` 中 `:root` 与 `.dark` 定义 HSL 变量（background、foreground、card、primary、muted 等），Tailwind 使用 `hsl(var(--xxx))`；`ThemeProvider` 使用 `attribute="class"`，`ModeToggle` 切换 class。
- **Tailwind**：与 UploadThing 通过 `withUt` 集成；`tailwind.config.ts` 中配置 content 路径、主题扩展（颜色、圆角）、tailwindcss-animate。

### 5.3 客户端交互要点

- **乐观更新**：点赞时先更新 UI 点赞数与红心状态，请求失败则回滚。
- **加载与禁用**：发帖、评论、点赞、关注、删除等有 loading 状态或 disabled，避免重复提交。
- **未登录引导**：点赞、评论处使用 `SignInButton` 引导登录；帖子列表未登录也可浏览。

---

## 六、配置与环境

### 6.1 环境变量（.env）

- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` / `CLERK_SECRET_KEY`：Clerk。
- `DATABASE_URL`：PostgreSQL 连接串，供 Prisma 使用。
- `UPLOADTHING_TOKEN`：UploadThing。

### 6.2 脚本与构建

- `npm run dev`：开发；`npm run build` / `npm run start`：生产构建与启动。
- `npm run lint`：Next 的 ESLint。
- `postinstall`：`prisma generate`，保证 Prisma Client 与 schema 一致。

### 6.3 其他配置

- **next.config.mjs**：空配置对象，未做自定义。
- **tsconfig.json**：严格模式、路径 `@/*`、Next 插件、include/exclude 常规设置。
- **components.json**：Shadcn 使用 new-york 风格、RSC、Tailwind 与 `globals.css`、无前缀、Lucide 图标。

---

## 七、安全与权限

- **路由与 API**：Clerk 中间件保护页面；UploadThing middleware 校验 `userId`；删除帖子时在 Server Action 内校验 `post.authorId === currentUserId`。
- **用户身份**：业务逻辑统一通过 `getDbUserId()` 取得 DB 用户 id，避免直接依赖 Clerk id 做关联。

---

## 八、可改进点（简要）

1. **Tasks 页面**：`/tasks` 仅占位，可补全列表与操作 UI，或移除/改为演示说明。  
2. **API 示例**：`/api/tasks` 为内存存储，仅适合演示；若保留可改为从 DB 读写或标注为 Demo。  
3. **移动端 Profile 链接**：`MobileNavbar` 中 Profile 指向 `/profile`，与动态路由 `/profile/[username]` 不一致，可改为当前用户 username 或从 Clerk 取。  
4. **loading/error 边界**：未使用 `loading.tsx`、`error.tsx`，可在关键路由增加以提升加载与错误体验。  
5. **通知已读**：当前为进入页面即全部标已读，可按需改为「标记单条」或「标记为已读」按钮。  
6. **WhoToFollow**：随机 3 人无持久随机种子，刷新会变；若需稳定推荐可改为基于关注关系或活跃度。

---

## 九、总结

本项目是一个结构清晰的 **Next.js 14 全栈社交应用**，覆盖：

- **App Router**：服务端/客户端组件划分、动态路由、布局、元数据。  
- **数据流**：Server Actions（帖子、用户、资料、通知）+ Prisma + revalidate。  
- **认证与同步**：Clerk + 中间件 + DB 用户同步。  
- **社交能力**：发帖、评论、点赞、关注、通知（点赞/评论/关注）。  
- **文件上传**：UploadThing 集成与权限控制。  
- **UI/UX**：Shadcn、Tailwind、明暗主题、乐观更新、骨架屏与基础响应式布局。

适合作为 Next.js 全栈与社交场景的练手或教学项目，并可在上述可改进点上继续扩展（如 loading/error、推荐算法、实时通知等）。
